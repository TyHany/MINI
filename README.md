# 项目开发日志

## 2024-03-21 会话总结

### 主要目的
- 完成项目架构设计和数据库设计

### 完成的主要任务
1. 修改了项目架构，将SQLite改为MySQL
2. 创建了完整的数据库表结构
3. 设置了管理员初始账号

### 关键决策和解决方案
- 采用MySQL替代SQLite，提供更熟悉的数据库环境
- 保持项目其他部分的简单性和轻量级特性
- 使用MD5加密存储管理员密码

### 使用的技术栈
- 前端：微信小程序原生开发
- 后端：Node.js + Express.js
- 数据库：MySQL
- 管理后台：原生JavaScript

### 修改的文件
1. set.md（主架构文档）
2. 项目目录结构-前端_set.md
3. 项目目录结构-后端_set.md
4. 项目目录结构-管理后台_set.md
5. 新建：数据库建表语句.sql

### 遇到的问题及解决方案
- 问题：需要在保持项目简单性的同时转向MySQL
- 解决：仅替换数据库相关配置，保持其他架构不变

### 新的想法和改进建议
1. 可以考虑添加数据库备份脚本
2. 后续可以添加数据库迁移工具
3. 考虑添加简单的数据库连接池管理 

## 2024-07-08 会话总结

### 主要目的
- 解决管理后台无法登录的问题，完成核心认证模块的重构。

### 完成的主要任务
1. **诊断并定位根源问题**：发现登录逻辑错误地使用了基于本地文件的认证，而非项目要求的数据库认证。
2. **移除错误代码**：删除了硬编码的 `admins.js` 和 `admins.json` 文件及其相关认证逻辑。
3. **重构认证路由**：彻底改造了 `/api/auth/login` 接口，实现与 MySQL 数据库的对接。
4. **升级密码安全**：将密码验证方式从不安全的 MD5 升级为行业标准的 `bcrypt` 哈希加盐算法。
5. **修复数据库表结构**：修正了 `admins` 表的 `password` 字段长度过短、无法存储 `bcrypt` 哈希的问题。
6. **调试环境问题**：解决了在 Windows 环境下 `.env` 配置文件因编码问题无法被 Node.js 正确读取的故障。

### 关键决策和解决方案
- **决策**：废弃所有与文件系统相关的认证代码，严格遵循数据库驱动的原则进行重构。
- **解决方案**：
    - 采用 `mysql2/promise` 库建立稳定的数据库连接池。
    - 使用 `bcrypt.compare` 方法安全地比对用户输入的密码和数据库中存储的哈希值。
    - 在 `auth.js` 和 `server.js` 中添加了详细的诊断日志，通过逐步排查法，先后解决了“数据库拒绝访问 (无密码)” -> “数据库拒绝访问 (有密码)” -> “密码哈希被截断导致验证失败”等一系列连锁问题。

### 使用的技术栈
- **后端**: Node.js, Express.js
- **数据库**: MySQL
- **核心依赖库**: `mysql2`, `bcryptjs`, `jsonwebtoken`, `dotenv`

### 修改的文件
- **主要修改**: `mall-admin/src/routes/auth.js`
- **配置修改**: `mall-admin/src/config/db.js`, `mall-admin/server.js`
- **数据修正**: `数据库建表语句.sql`
- **环境配置**: `mall-admin/.env` (新建并调试)
- **已删除**: `mall-admin/src/config/admins.js`, `mall-admin/src/config/admins.json`

### 遇到的问题及解决方案
- **问题 1**: 服务器启动时报数据库“拒绝访问（使用密码: NO）”。
    - **解决方案**: 诊断为 `.env` 文件未被正确加载。通过在 PowerShell 中使用 `echo` 命令重建 `.env` 文件，确保其为正确的 ANSI/UTF-8 编码，使 Node.js 能成功读取。
- **问题 2**: 数据库连接成功后，登录始终返回 401 未授权。
    - **解决方案**: 通过在代码中打印数据库取出的哈希值和其长度，发现 `password` 字段 (`VARCHAR(32)`) 截断了 `bcrypt` 生成的60位字符哈希。通过 SQL `ALTER TABLE` 命令将字段长度修改为 `VARCHAR(255)`，并重新插入正确的用户数据后，问题解决。

### 新的想法和改进建议
- 建议为 Express 应用增加一个全局错误处理中间件，可以更优雅、统一地处理未来可能出现的各类运行时错误。
- 在开发流程中引入 `nodemon` 工具，可以监听文件变化并自动重启服务，极大地提升开发和调试效率。 

## 2024-07-09 会话总结

### 主要目的
- 搭建完整的后端API骨架，确保所有业务功能均有对应的接口，并识别出功能缺口。

### 完成的主要任务
1. **重构前端资源管理**：将所有客户端静态文件（HTML, JS）从 `src` 目录迁移到 `public` 目录，并修改服务器配置，使其仅暴露 `public` 目录，增强了项目的安全性与规范性。
2. **修复静态文件引用路径**：解决了因文件迁移和服务器配置更改导致的所有 `ERR_FILE_NOT_FOUND` 错误。
3. **系统性地搭建API骨架**：根据项目需求文档，为商品、分类、订单、用户、购物车、收货地址、轮播图等所有模块，创建了对应的路由文件和API接口占位符。
4. **注册所有API路由**：在主服务器文件 `server.js` 中引入并注册了所有新建的API模块，使整个后端的API结构变得清晰完整。
5. **功能覆盖性审查与补全**：审查发现缺少了微信支付处理和用户聚合数据相关的关键API，并据此提出了新增支付接口 (`/api/pay/prepay`, `/api/pay/notify`) 和用户数据统计接口 (`/api/user/stats`) 的设计方案。

### 关键决策和解决方案
- **决策**：采用“API优先”的策略，先完成所有接口的结构设计和骨架搭建，再分模块填充业务逻辑。
- **解决方案**：通过模块化的方式创建独立的路由文件（如 `goods.js`, `orders.js`），使得项目结构清晰，便于未来分工协作和维护。

### 使用的技术栈
- **后端**: Node.js, Express.js

### 修改的文件
- **核心修改**: `mall-admin/server.js` (注册所有路由)
- **新增路由文件**:
  - `mall-admin/src/routes/banners.js`
  - `mall-admin/src/routes/categories.js`
  - `mall-admin/src/routes/goods.js`
  - `mall-admin/src/routes/orders.js`
  - `mall-admin/src/routes/users.js`
  - `mall-admin/src/routes/cart.js`
  - `mall-admin/src/routes/address.js`
- **前端文件迁移与路径修复**: `mall-admin/public/pages/login/login.html` 等。

### 新的想法和改进建议
- **微信支付流程细化**：下一步需要细化支付接口的实现，严格遵循微信支付的官方文档流程，包括与微信服务器的服务端到服务端通信。
- **引入API文档工具**：未来可以考虑使用 `Swagger` 或 `JSDoc` 等工具，为这些API自动生成可交互的文档，能极大地提升前后端的协作效率。 